name: Record clone metrics

on:
  workflow_call:
    inputs:
      observed-repo:
        description: "Repository to fetch clone metrics from (OWNER/REPO)"
        required: false
        default: ${{ github.repository }}
        type: string
      metrics-repo:
        description: "Target repo for storing metrics (OWNER/REPO)"
        required: true
        type: string
    secrets:
      METRICS_PAT:
        required: true

permissions:
  contents: read

jobs:
  record:
    runs-on: ubuntu-latest
    steps:
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Fetch clone stats
        env:
          GH_TOKEN: ${{ secrets.METRICS_PAT }}
          OBSERVED_REPO: ${{ inputs.observed-repo }}
        run: |
          curl -L \
            -D headers.txt \
            -o clones.json \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/$OBSERVED_REPO/traffic/clones

          CLONES=$(jq -r '.count // 0' clones.json)
          UNIQUES=$(jq -r '.uniques // 0' clones.json)

          echo "CLONES=$CLONES" >> $GITHUB_ENV
          echo "UNIQUES=$UNIQUES" >> $GITHUB_ENV

      - name: Debug auth identity
        env:
          GH_TOKEN: ${{ secrets.METRICS_PAT }}
        run: |
          curl -s \
            -H "Authorization: Bearer $GH_TOKEN" \
            https://api.github.com/user | jq '{login, id}'

      - name: Debug repo access
        env:
          GH_TOKEN: ${{ secrets.METRICS_PAT }}
          OBSERVED_REPO: ${{ inputs.observed-repo }}
        run: |
          curl -s \
            -H "Authorization: Bearer $GH_TOKEN" \
            https://api.github.com/repos/$OBSERVED_REPO | jq '{full_name, private}'

      - name: Debug clone API
        run: |
          echo "===== clones.json ====="
          cat clones.json
          echo "======================"

      
      - name: Append and Deduplicate metrics CSV
        run: |
          set -e

          # 1. Setup Repo
          git clone https://x-access-token:${{ secrets.METRICS_PAT }}@github.com/${{ inputs.metrics-repo }}.git metrics-temp
          cd metrics-temp
          git config user.name "metrics-bot"
          git config user.email "metrics-bot@users.noreply.github.com"

          # 2. Setup File
          FILE="data/$(echo '${{ github.repository }}' | tr '/' '__').csv"
          mkdir -p data
          if [ ! -f "$FILE" ]; then
            echo "date,repository,clones,uniques" > "$FILE"
          fi

          REPO="${{ github.repository }}"

          # 3. GET THE LATEST DATE FROM JSON
          # This looks at the last entry in the clones array and grabs the first 10 chars (YYYY-MM-DD)
          # Note: the last recorded date is not necessarily today's date
          LATEST_JSON_DATE=$(jq -r '.clones[-1].timestamp[0:10]' ../clones.json)

          # If for some reason the JSON is empty, fallback to system date to avoid errors
          if [ "$LATEST_JSON_DATE" == "null" ] || [ -z "$LATEST_JSON_DATE" ]; then
            LATEST_JSON_DATE=$(date +%F)
          fi

          # 4. APPEND ALL DATA (Raw)
          # Get daily stats from clones.json and append to $FILE
          jq -r --arg REPO "$REPO" '.clones[] | [.timestamp[0:10], $REPO, .count, .uniques] | @csv' ../clones.json >> "$FILE"   
          # Append the summary using the LATEST_JSON_DATE and the Tilde (~) for sorting
          jq -r --arg REPO "$REPO" --arg DATE "$LATEST_JSON_DATE" \
            '[ "\($DATE)~ 14-day total", $REPO, .count, .uniques ] | @csv' ../clones.json >> "$FILE"
          
          # 5. DEDUPLICATE AND SORT DESCENDING (The "Magic" Step) 
          # Check if the first line is actually the header. If not, we add it.
          if ! head -n 1 "$FILE" | grep -q "^date,"; then
              # No header found? Prepend it to the file.
              SED_HEADER="date,repository,clones,uniques"
              sed -i "1i $SED_HEADER" "$FILE"
          fi
          
          # Save the header to the tmp file first
          head -n 1 "$FILE" > "$FILE.tmp"
          # take everything EXCEPT the header (tail -n +2), deduplicate with awk, and sort desc
          # -F, : Use comma as separator
          tail -n +2 "$FILE" | awk -F, '{a[$1,$2]=$0} END {for (i in a) print a[i]}' | sort -t, -k1,1r >> "$FILE.tmp"
          
          mv "$FILE.tmp" "$FILE"

          # 6. Commit and Push
          git add "$FILE"
          git commit -m "metrics: record and deduplicate stats for $REPO" || true
          git push
    
 