name: Record clone and view metrics

on:
  workflow_call:
    inputs:
      observed-repo:
        description: "Repository to fetch clone and view metrics from (OWNER/REPO)"
        required: false
        default: ${{ github.repository }}
        type: string
      metrics-repo:
        description: "Target repo for storing metrics (OWNER/REPO)"
        required: true
        type: string
    secrets:
      METRICS_PAT:
        required: true

permissions:
  contents: read

jobs:
  record:
    runs-on: ubuntu-latest
    steps:
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Fetch Traffic Stats (Clones and Views)
        env:
          GH_TOKEN: ${{ secrets.METRICS_PAT }}
          OBSERVED_REPO: ${{ inputs.observed-repo }}
        run: |
          # Fetch Clones
          curl -L -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            -o clones.json \
            https://api.github.com/repos/$OBSERVED_REPO/traffic/clones

          # Fetch Views
          curl -L -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            -o views.json \
            https://api.github.com/repos/$OBSERVED_REPO/traffic/views
            

      - name: Append and Deduplicate metrics CSV
        run: |
          set -e

          # 1. Setup Repo
          git clone https://x-access-token:${{ secrets.METRICS_PAT }}@github.com/${{ inputs.metrics-repo }}.git metrics-temp
          cd metrics-temp
          git config user.name "metrics-bot"
          git config user.email "metrics-bot@users.noreply.github.com"

          # 2. Setup File with new header: date,repository,type,count,uniques
          FILE="data/$(echo '${{ github.repository }}' | tr '/' '__').csv"
          HEADER="date,repository,type,count,uniques"
          mkdir -p data
          
          if [ ! -f "$FILE" ]; then
            echo "$HEADER" > "$FILE"
          fi

          REPO="${{ github.repository }}"

          # 3. Process Clones (Daily and Summary)
          LATEST_CLONE_DATE=$(jq -r '.clones[-1].timestamp[0:10] // empty' ../clones.json)
          [ -z "$LATEST_CLONE_DATE" ] && LATEST_CLONE_DATE=$(date +%F)

          # Daily Clones
          jq -r --arg REPO "$REPO" '.clones[] | [.timestamp[0:10], $REPO, "clones", .count, .uniques] | @csv' ../clones.json >> "$FILE"
          # Summary Clones
          jq -r --arg REPO "$REPO" --arg DATE "$LATEST_CLONE_DATE" \
            '[ "\($DATE)~ 14-day total", $REPO, "clones_total", .count, .uniques ] | @csv' ../clones.json >> "$FILE"

          # 4. Process Views (Daily and Summary)
          LATEST_VIEW_DATE=$(jq -r '.views[-1].timestamp[0:10] // empty' ../views.json)
          [ -z "$LATEST_VIEW_DATE" ] && LATEST_VIEW_DATE=$(date +%F)

          # Daily Views
          jq -r --arg REPO "$REPO" '.views[] | [.timestamp[0:10], $REPO, "views", .count, .uniques] | @csv' ../views.json >> "$FILE"
          # Summary Views
          jq -r --arg REPO "$REPO" --arg DATE "$LATEST_VIEW_DATE" \
            '[ "\($DATE)~ 14-day total", $REPO, "views_total", .count, .uniques ] | @csv' ../views.json >> "$FILE"

          # 5. DEDUPLICATE AND SORT
          # Ensure header is correct (migrates old 4-column files to 5-column if necessary)
          echo "$HEADER" > "$FILE.tmp"
          
          # The AWK Key is now $1 (date), $2 (repo), and $3 (type). 
          # This allows a 'clones' and 'views' entry for the same day.
          tail -n +2 "$FILE" | awk -F, '$3!="" {a[$1,$2,$3]=$0} END {for (i in a) print a[i]}' | sort -t, -k1,1r >> "$FILE.tmp"
          
          mv "$FILE.tmp" "$FILE"

          # 6. Commit and Push
          git add "$FILE"
          git commit -m "metrics: record clones and views for $REPO" || true
          git push    
          
